<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED AI NAVIGATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: rgba(255,255,255,0.03);
            --surface-solid: #0a0a0a;
            --elevated: rgba(255,255,255,0.06);
            --border: rgba(255,255,255,0.08);
            --text: #ffffff;
            --text-s: rgba(255,255,255,0.6);
            --text-m: rgba(255,255,255,0.3);
            --accent: #dc2626;
            --accent-s: rgba(220,38,38,0.15);
            --accent-g: rgba(220,38,38,0.4);
            --grad: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --success: #22c55e;
            --locked: rgba(255,255,255,0.2);
        }
        [data-theme="light"] {
            --bg: #ffffff;
            --surface: rgba(0,0,0,0.02);
            --surface-solid: #fafafa;
            --elevated: rgba(0,0,0,0.04);
            --border: rgba(0,0,0,0.08);
            --text: #000000;
            --text-s: rgba(0,0,0,0.6);
            --text-m: rgba(0,0,0,0.3);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}

        /* Starfield */
        #stars{position:fixed;inset:0;z-index:0}

        /* Layout */
        .app{position:relative;z-index:1;height:100%;display:grid;grid-template-columns:280px 1fr;grid-template-rows:60px 1fr}

        /* Header */
        .header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.5);backdrop-filter:blur(20px)}
        .header-left{display:flex;align-items:center;gap:16px}
        .menu-btn{display:none;width:40px;height:40px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:18px}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:36px;height:36px;background:var(--grad);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Syne';font-weight:800;font-size:16px;color:#fff}
        .logo-text{font-family:'Syne';font-weight:700;font-size:18px;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .header-center{display:flex;align-items:center;gap:8px;padding:6px 14px;border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text-s)}
        .header-center span{color:var(--accent);font-weight:600}
        .header-right{display:flex;align-items:center;gap:12px}
        .icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:transparent;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--text)}
        .icon-btn:hover{background:var(--elevated);border-color:var(--accent)}

        /* Sidebar */
        .sidebar{border-right:1px solid var(--border);background:rgba(0,0,0,0.3);backdrop-filter:blur(20px);display:flex;flex-direction:column;overflow:hidden}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
        .sidebar-title{font-family:'Syne';font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-m);margin-bottom:12px}
        .progress-wrap{background:var(--surface);border-radius:8px;padding:12px}
        .progress-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:8px}
        .progress-label span:first-child{color:var(--text-s)}
        .progress-label span:last-child{color:var(--accent);font-weight:600}
        .progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
        .progress-fill{height:100%;background:var(--grad);border-radius:2px;transition:width .5s}

        .sidebar-modules{flex:1;overflow-y:auto;padding:12px}
        .sidebar-modules::-webkit-scrollbar{width:4px}
        .sidebar-modules::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

        .module-group{margin-bottom:20px}
        .module-group-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-m);padding:8px 12px}

        .module-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:all .2s;margin-bottom:4px}
        .module-item:hover{background:var(--elevated)}
        .module-item.active{background:var(--accent-s);border:1px solid rgba(220,38,38,0.3)}
        .module-item.locked{opacity:0.4;cursor:not-allowed}
        .module-item.locked:hover{background:transparent}
        .module-item.completed .module-status{background:var(--success);color:#fff}

        .module-status{width:28px;height:28px;border-radius:8px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
        .module-item.locked .module-status{background:var(--locked)}
        .module-info{flex:1;min-width:0}
        .module-name{font-size:13px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .module-meta{font-size:11px;color:var(--text-m)}

        /* Main Content */
        .main{display:flex;flex-direction:column;overflow:hidden;position:relative}

        /* Intro Progress Indicator */
        .intro-progress{padding:16px 40px;background:var(--surface-solid);border-bottom:1px solid var(--border);display:none}
        .intro-progress.show{display:block}
        .intro-steps{display:flex;gap:12px;max-width:720px;margin:0 auto}
        .intro-step{flex:1;display:flex;flex-direction:column;gap:6px}
        .intro-step-num{font-size:11px;color:var(--text-m);font-weight:600}
        .intro-step-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
        .intro-step-fill{height:100%;background:var(--grad);border-radius:2px;width:0%;transition:width 0.5s}
        .intro-step.completed .intro-step-fill{width:100%}
        .intro-step.completed .intro-step-num{color:var(--accent)}
        .intro-step-label{font-size:10px;color:var(--text-m)}

        /* Chat Area */
        .chat{flex:1;overflow-y:auto;padding:40px;display:flex;flex-direction:column;gap:24px}
        .chat::-webkit-scrollbar{width:6px}
        .chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

        /* Messages */
        .msg{max-width:720px;animation:msgIn .4s ease}
        @keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
        .msg.user{align-self:flex-end}
        .msg-bub{font-size:15px;line-height:1.7}
        .msg.bot .msg-bub{color:var(--text)}
        .msg.user .msg-bub{background:var(--elevated);border:1px solid var(--border);padding:14px 20px;border-radius:16px}
        .msg-bub img{max-width:100%;border-radius:12px;margin-top:12px}

        /* Quick Reply Buttons */
        .quick-replies{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .quick-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;font-family:'Inter',sans-serif;transition:all .2s}
        .quick-btn:hover{background:var(--accent-s);border-color:var(--accent);transform:translateY(-2px)}
        .quick-btn:active{transform:translateY(0)}

        /* Typing */
        .typing{display:flex;gap:5px}
        .typing span{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:typ 1.4s infinite}
        .typing span:nth-child(2){animation-delay:.15s}
        .typing span:nth-child(3){animation-delay:.3s}
        @keyframes typ{0%,60%,100%{opacity:.3}30%{opacity:1}}

        /* Input Area */
        .input-area{padding:20px 40px 32px;background:linear-gradient(to top,rgba(0,0,0,0.8) 0%,transparent 100%)}
        .input-wrap{max-width:720px;margin:0 auto;background:var(--surface-solid);border:1px solid var(--border);border-radius:16px;padding:4px;display:flex;align-items:flex-end;gap:4px;transition:border-color .2s}
        .input-wrap:focus-within{border-color:var(--accent)}
        .attach{width:44px;height:44px;border-radius:12px;border:none;background:transparent;cursor:pointer;font-size:18px;color:var(--text-s);transition:all .2s}
        .attach:hover{background:var(--elevated);color:var(--text)}
        textarea{flex:1;background:transparent;border:none;padding:12px 8px;font-size:15px;color:var(--text);font-family:'Inter',sans-serif;resize:none;min-height:44px;max-height:120px}
        textarea:focus{outline:none}
        textarea::placeholder{color:var(--text-m)}
        .send{width:44px;height:44px;background:var(--grad);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .send:hover{transform:scale(1.05)}
        .send:disabled{opacity:0.5;cursor:not-allowed;transform:scale(1)}
        .send svg{width:18px;height:18px;fill:#fff}

        /* Overlays */
        .overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:40px;background:var(--bg)}
        .overlay.hid{display:none}

        /* Language Screen */
        .lang-logo{display:flex;flex-direction:column;align-items:center;gap:20px}
        .lang-icon{width:80px;height:80px;background:var(--grad);border-radius:20px;display:flex;align-items:center;justify-content:center;font-family:'Syne';font-weight:800;font-size:36px;color:#fff;box-shadow:0 0 80px var(--accent-g);animation:pulse 3s ease-in-out infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 60px var(--accent-g)}50%{box-shadow:0 0 100px var(--accent-g)}}
        .lang-title{font-family:'Syne';font-weight:800;font-size:32px}
        .lang-sub{font-size:15px;color:var(--text-s);max-width:400px;text-align:center}
        .lang-opts{display:flex;gap:16px}
        .lang-btn{display:flex;flex-direction:column;align-items:center;gap:12px;padding:28px 44px;background:var(--surface);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .3s}
        .lang-btn:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 20px 40px -12px var(--accent-g)}
        .lang-fl{font-size:40px}
        .lang-nm{font-family:'Syne';font-weight:600;font-size:16px;color:var(--text)}

        /* API Key Screen */
        .api-box{max-width:500px;background:var(--surface-solid);border:1px solid var(--border);border-radius:20px;padding:40px;text-align:center}
        .api-title{font-family:'Syne';font-size:24px;font-weight:700;margin-bottom:12px}
        .api-sub{color:var(--text-s);margin-bottom:24px;line-height:1.6;font-size:14px}
        .api-notice{background:var(--accent-s);border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:24px;display:flex;gap:12px;align-items:start;text-align:left}
        .api-notice-icon{font-size:20px;flex-shrink:0}
        .api-notice-text{font-size:13px;line-height:1.6;color:var(--text)}
        .api-notice-text strong{color:var(--accent);font-weight:600}
        .api-input-wrap{margin-bottom:20px}
        .api-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:14px;color:var(--text);font-family:'Inter',sans-serif;transition:border-color .2s}
        .api-input:focus{outline:none;border-color:var(--accent)}
        .api-input::placeholder{color:var(--text-m)}
        .api-btn{width:100%;background:var(--grad);border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:600;color:#fff;cursor:pointer;transition:all .2s;font-family:'Syne'}
        .api-btn:hover{transform:translateY(-2px);box-shadow:0 12px 24px -8px var(--accent-g)}
        .api-btn:disabled{opacity:0.5;cursor:not-allowed;transform:translateY(0)}
        .api-error{color:#ef4444;font-size:13px;margin-top:12px}
        .api-help{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
        .api-help-title{font-size:12px;font-weight:600;color:var(--text-s);margin-bottom:8px}
        .api-help-link{color:var(--accent);font-size:13px;text-decoration:none}
        .api-help-link:hover{text-decoration:underline}

        /* Module Completion Popup */
        .completion-overlay{position:fixed;inset:0;z-index:2000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);backdrop-filter:blur(10px)}
        .completion-overlay.show{display:flex;animation:fadeIn 0.5s ease}

        .completion-box{max-width:600px;background:var(--surface-solid);border:2px solid var(--accent);border-radius:24px;padding:48px;text-align:center;position:relative;animation:popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)}
        @keyframes popIn{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}

        .completion-icon{width:100px;height:100px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:48px;animation:bounce 1s ease infinite;box-shadow:0 0 100px var(--accent-g)}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

        .completion-title{font-family:'Syne';font-size:32px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
        .completion-subtitle{font-family:'Syne';font-size:18px;font-weight:600;color:var(--text);margin-bottom:16px}
        .completion-message{color:var(--text-s);font-size:15px;line-height:1.7;margin-bottom:32px}

        .progress-complete{background:var(--surface);border-radius:12px;padding:20px;margin-bottom:32px}
        .progress-complete-label{font-size:13px;color:var(--text-s);margin-bottom:12px}
        .progress-complete-bar{height:12px;background:var(--border);border-radius:6px;overflow:hidden;position:relative}
        .progress-complete-fill{height:100%;background:var(--grad);border-radius:6px;transition:width 2s cubic-bezier(0.68, -0.55, 0.265, 1.55);box-shadow:0 0 20px var(--accent-g)}

        .completion-actions{display:flex;gap:12px}
        .completion-btn{flex:1;padding:16px;border-radius:12px;font-family:'Syne';font-weight:600;font-size:15px;cursor:pointer;transition:all 0.3s;border:none}
        .completion-btn.primary{background:var(--grad);color:#fff}
        .completion-btn.primary:hover{transform:translateY(-2px);box-shadow:0 12px 24px -8px var(--accent-g)}
        .completion-btn.secondary{background:var(--surface);color:var(--text);border:1px solid var(--border)}
        .completion-btn.secondary:hover{background:var(--elevated);border-color:var(--accent)}

        /* Confetti Canvas */
        #confetti{position:fixed;inset:0;z-index:1999;pointer-events:none;display:none}
        #confetti.show{display:block}

        /* Correction Options */
        .correction-options{display:none;flex-direction:column;gap:12px;margin-top:24px}
        .correction-options.show{display:flex}
        .correction-btn{background:var(--elevated);border:1px solid var(--border);padding:14px;border-radius:12px;color:var(--text);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;font-family:'Inter'}
        .correction-btn:hover{background:var(--accent-s);border-color:var(--accent);transform:translateX(4px)}

        /* Responsive */
        @media(max-width:900px){
            .app{grid-template-columns:1fr}
            .sidebar{position:fixed;left:0;top:60px;bottom:0;width:280px;z-index:100;transform:translateX(-100%);transition:transform .3s}
            .sidebar.open{transform:translateX(0)}
            .menu-btn{display:flex}
            .header-center{display:none}
        }
        @media(max-width:600px){
            .chat{padding:24px 16px}
            .input-area{padding:16px}
            .lang-opts{flex-direction:column}
            .lang-title{font-size:24px}
            .api-box{padding:24px;margin:20px}
            .completion-box{padding:32px;margin:20px}
            .intro-progress{padding:12px 16px}
            .intro-steps{gap:8px}
        }

        #fi{display:none}
    </style>
</head>
<body>
    <canvas id="stars"></canvas>
    <canvas id="confetti"></canvas>

    <!-- Module Completion Popup -->
    <div class="completion-overlay" id="completionOv">
        <div class="completion-box">
            <div class="completion-icon">ğŸ‰</div>
            <div class="completion-title" id="completionTitle">GlÃ¼ckwunsch!</div>
            <div class="completion-subtitle" id="completionSubtitle">Modul Abgeschlossen</div>
            <div class="completion-message" id="completionMessage">Deine Informationen wurden gespeichert und ich habe deinen personalisierten Lernpfad vorbereitet!</div>

            <div class="progress-complete">
                <div class="progress-complete-label" id="progressCompleteLabel">Fortschritt: 7%</div>
                <div class="progress-complete-bar">
                    <div class="progress-complete-fill" id="progressCompleteFill" style="width:0%"></div>
                </div>
            </div>

            <div class="completion-actions" id="completionActions">
                <button class="completion-btn primary" onclick="continueToNextModule()" id="continueBtn">Weiter zum nÃ¤chsten Modul â†’</button>
                <button class="completion-btn secondary" onclick="showCorrectionOptions()" id="repeatBtn">ğŸ”„ Modul wiederholen</button>
            </div>

            <div class="correction-options" id="correctionOptions">
                <div style="font-size:14px;color:var(--text-s);margin-bottom:8px;" id="correctionTitle">Welchen Bereich mÃ¶chtest du korrigieren?</div>
                <button class="correction-btn" onclick="correctField('name')">ğŸ‘¤ <span id="corrField1">Dein Name</span></button>
                <button class="correction-btn" onclick="correctField('goal')">ğŸ¯ <span id="corrField2">Dein Ziel</span></button>
                <button class="correction-btn" onclick="correctField('time')">â° <span id="corrField3">VerfÃ¼gbare Zeit</span></button>
                <button class="correction-btn" onclick="correctField('experience')">ğŸ“š <span id="corrField4">Erfahrungslevel</span></button>
            </div>
        </div>
    </div>

    <!-- Language Selection -->
    <div class="overlay" id="langOv">
        <div class="lang-logo">
            <div class="lang-icon">R</div>
            <div class="lang-title">RED AI NAVIGATOR</div>
            <div class="lang-sub">Master AI and build your income stream with guided learning</div>
        </div>
        <div class="lang-opts">
            <button class="lang-btn" onclick="selectLang('de')"><span class="lang-fl">ğŸ‡©ğŸ‡ª</span><span class="lang-nm">Deutsch</span></button>
            <button class="lang-btn" onclick="selectLang('en')"><span class="lang-fl">ğŸ‡¬ğŸ‡§</span><span class="lang-nm">English</span></button>
            <button class="lang-btn" onclick="selectLang('ru')"><span class="lang-fl">ğŸ‡·ğŸ‡º</span><span class="lang-nm">Ğ ÑƒÑÑĞºĞ¸Ğ¹</span></button>
        </div>
    </div>

    <!-- API Key Input -->
    <div class="overlay hid" id="apiOv">
        <div class="lang-icon">ğŸ”‘</div>
        <div class="api-box">
            <div class="api-title" id="apiTitle">Connect Your AI</div>
            <div class="api-sub" id="apiSub">Enter your Anthropic API key to unlock the full RED AI Navigator experience. Your key is stored locally and never shared.</div>

            <div class="api-notice">
                <div class="api-notice-icon">ğŸ’¡</div>
                <div class="api-notice-text">
                    <strong id="apiNoticeTitle">Important:</strong> <span id="apiNoticeText">Your API key will be saved in your browser. All your progress, answers, and conversations will be stored under this key. Don't forget your API key!</span>
                </div>
            </div>

            <div class="api-input-wrap">
                <input type="password" id="apiKey" class="api-input" placeholder="sk-ant-api03-...">
            </div>
            <button class="api-btn" onclick="saveApiKey()" id="apiBtn">Start Journey â†’</button>
            <div class="api-error" id="apiError"></div>
            <div class="api-help">
                <div class="api-help-title">Don't have an API key?</div>
                <a href="https://console.anthropic.com/settings/keys" target="_blank" class="api-help-link">Get one from Anthropic â†’</a>
            </div>
        </div>
    </div>

    <div class="app" style="display:none" id="app">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
                <div class="logo">
                    <div class="logo-icon">R</div>
                    <div class="logo-text">RED AI NAVIGATOR</div>
                </div>
            </div>
            <div class="header-center">
                <span id="currentModule">Intro</span>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
            </div>
        </header>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Your Progress</div>
                <div class="progress-wrap">
                    <div class="progress-label">
                        <span>Overall</span>
                        <span id="totalProgress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="sidebar-modules" id="moduleList"></div>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;">
                <button onclick="confirmDeleteAll()" style="width: 100%; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                    ğŸ—‘ï¸ <span id="deleteAllBtn">Alles lÃ¶schen</span>
                </button>
            </div>
        </aside>

        <main class="main">
            <!-- Intro Progress Indicator -->
            <div class="intro-progress" id="introProgress">
                <div class="intro-steps">
                    <div class="intro-step" id="step1">
                        <div class="intro-step-num">1</div>
                        <div class="intro-step-bar"><div class="intro-step-fill"></div></div>
                        <div class="intro-step-label" id="step1Label">Name</div>
                    </div>
                    <div class="intro-step" id="step2">
                        <div class="intro-step-num">2</div>
                        <div class="intro-step-bar"><div class="intro-step-fill"></div></div>
                        <div class="intro-step-label" id="step2Label">Goal</div>
                    </div>
                    <div class="intro-step" id="step3">
                        <div class="intro-step-num">3</div>
                        <div class="intro-step-bar"><div class="intro-step-fill"></div></div>
                        <div class="intro-step-label" id="step3Label">Time</div>
                    </div>
                    <div class="intro-step" id="step4">
                        <div class="intro-step-num">4</div>
                        <div class="intro-step-bar"><div class="intro-step-fill"></div></div>
                        <div class="intro-step-label" id="step4Label">Experience</div>
                    </div>
                </div>
            </div>

            <div class="chat" id="chat"></div>

            <div class="input-area">
                <div class="input-wrap">
                    <button class="attach" onclick="toggleDrop()">ğŸ“·</button>
                    <textarea id="inp" placeholder="Type your answer..." rows="1" onkeydown="handleKey(event)"></textarea>
                    <button class="send" onclick="send()" id="sendBtn">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
            <input type="file" id="fi" accept="image/*">
        </main>
    </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARFIELD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let stars = [];

function initStars() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    stars = [];
    for (let i = 0; i < 200; i++) {
        stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 1.5,
            opacity: Math.random()
        });
    }
}

function animateStars() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(star => {
        star.opacity += (Math.random() - 0.5) * 0.02;
        star.opacity = Math.max(0.1, Math.min(1, star.opacity));
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,255,255,${star.opacity * 0.6})`;
        ctx.fill();
    });
    requestAnimationFrame(animateStars);
}

window.addEventListener('resize', initStars);
initStars();
animateStars();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
    lang: null,
    apiKey: localStorage.getItem('red_ai_api_key') || null,
    currentModule: 'intro',
    completedModules: [],
    profile: {},
    introStep: 0,
    answeredQuestions: {},
    moduleConversations: {}
};

const MODULES = {
    intro: { id: 'intro', group: 'basics', icon: 'ğŸ‘‹', name: { en: 'Introduction', de: 'EinfÃ¼hrung', ru: 'Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ' } },
    what_is_ai: { id: 'what_is_ai', group: 'basics', icon: 'ğŸ¤–', name: { en: 'What is AI?', de: 'Was ist AI?', ru: 'Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ AI?' } },
    tokens: { id: 'tokens', group: 'basics', icon: 'ğŸŸï¸', name: { en: 'Tokens', de: 'Tokens', ru: 'Ğ¢Ğ¾ĞºĞµĞ½Ñ‹' } },
    context: { id: 'context', group: 'basics', icon: 'ğŸ“', name: { en: 'Context', de: 'Kontext', ru: 'ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚' } },
    voiceovers: { id: 'voiceovers', group: 'methods', icon: 'ğŸ™ï¸', name: { en: 'AI Voiceovers', de: 'AI Voiceovers', ru: 'AI ĞĞ·Ğ²ÑƒÑ‡ĞºĞ°' } },
    imagegen: { id: 'imagegen', group: 'methods', icon: 'ğŸ¨', name: { en: 'Image Generation', de: 'Bildgenerierung', ru: 'Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹' } },
    videogen: { id: 'videogen', group: 'methods', icon: 'ğŸ¬', name: { en: 'Video Generation', de: 'Videogenerierung', ru: 'Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¸Ğ´ĞµĞ¾' } },
    chatbots: { id: 'chatbots', group: 'methods', icon: 'ğŸ’¬', name: { en: 'Chatbots', de: 'Chatbots', ru: 'Ğ§Ğ°Ñ‚Ğ±Ğ¾Ñ‚Ñ‹' } },
    automation: { id: 'automation', group: 'methods', icon: 'âš™ï¸', name: { en: 'Automation', de: 'Automatisierung', ru: 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ' } },
    copywriting: { id: 'copywriting', group: 'methods', icon: 'âœï¸', name: { en: 'Copywriting', de: 'Copywriting', ru: 'ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ°Ğ¹Ñ‚Ğ¸Ğ½Ğ³' } },
    websites: { id: 'websites', group: 'methods', icon: 'ğŸ’»', name: { en: 'AI Websites', de: 'AI Websites', ru: 'AI Ğ¡Ğ°Ğ¹Ñ‚Ñ‹' } },
    research: { id: 'research', group: 'methods', icon: 'ğŸ“Š', name: { en: 'AI Research', de: 'AI Research', ru: 'AI Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ' } },
    consulting: { id: 'consulting', group: 'methods', icon: 'ğŸ“', name: { en: 'AI Consulting', de: 'AI Consulting', ru: 'AI ĞšĞ¾Ğ½ÑĞ°Ğ»Ñ‚Ğ¸Ğ½Ğ³' } },
    choose_path: { id: 'choose_path', group: 'decision', icon: 'ğŸ¯', name: { en: 'Choose Path', de: 'WÃ¤hle Weg', ru: 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¿ÑƒÑ‚ÑŒ' } },
    project: { id: 'project', group: 'project', icon: 'ğŸš€', name: { en: 'Your Project', de: 'Dein Projekt', ru: 'Ğ¢Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚' } }
};

const GROUPS = {
    basics: { en: 'Fundamentals', de: 'Grundlagen', ru: 'ĞÑĞ½Ğ¾Ğ²Ñ‹' },
    methods: { en: 'AI Methods', de: 'AI Methoden', ru: 'AI ĞœĞµÑ‚Ğ¾Ğ´Ñ‹' },
    decision: { en: 'Your Path', de: 'Dein Weg', ru: 'Ğ¢Ğ²Ğ¾Ğ¹ Ğ¿ÑƒÑ‚ÑŒ' },
    project: { en: 'Your Project', de: 'Dein Projekt', ru: 'Ğ¢Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚' }
};

const i18n = {
    en: {
        apiTitle: 'Connect Your AI',
        apiSub: 'Enter your Anthropic API key to unlock the full RED AI Navigator experience. Your key is stored locally and never shared.',
        apiBtn: 'Start Journey â†’',
        apiError: 'Invalid API key. Please check and try again.',
        apiHelp: "Don't have an API key?",
        apiHelpLink: 'Get one from Anthropic â†’',
        apiNoticeTitle: 'Important:',
        apiNoticeText: 'Your API key will be saved in your browser. All your progress, answers, and conversations will be stored under this key. Don\'t forget your API key!',
        // Quick reply buttons
        sideIncome: 'ğŸ’° Side Income',
        fullTime: 'ğŸš€ Full-time',
        exploring: 'ğŸ” Exploring',
        oneHour: '1h/day',
        twoThreeHours: '2-3h/day',
        fourPlusHours: '4+h/day',
        beginner: 'ğŸŒ± Beginner',
        intermediate: 'ğŸ“š Intermediate',
        advanced: 'ğŸš€ Advanced',
        // Completion popup
        congratulations: 'Congratulations!',
        moduleComplete: 'Module Complete',
        infoSaved: 'Your information has been saved and I\'ve prepared your personalized learning path!',
        continueNext: 'Continue to Next Module â†’',
        repeatModule: 'ğŸ”„ Repeat Module',
        whatToCorrect: 'What would you like to correct?',
        yourName: 'Your Name',
        yourGoal: 'Your Goal',
        timeAvailable: 'Available Time',
        experience: 'Experience Level',
        progress: 'Progress',
        // Intro steps
        stepName: 'Name',
        stepGoal: 'Goal',
        stepTime: 'Time',
        stepExperience: 'Experience',
        // Delete all
        deleteAllBtn: 'Delete Everything',
        deleteWarningTitle: 'Warning!',
        deleteWarningText: 'All your data will be deleted and you will start from the beginning. Are you sure?',
        deleteYes: 'Yes, delete everything',
        deleteNo: 'Cancel'
    },
    de: {
        apiTitle: 'Verbinde deine AI',
        apiSub: 'Gib deinen Anthropic API Key ein um die volle RED AI Navigator Erfahrung freizuschalten. Dein Key wird nur lokal gespeichert.',
        apiBtn: 'Reise Starten â†’',
        apiError: 'UngÃ¼ltiger API Key. Bitte prÃ¼fen.',
        apiHelp: 'Noch keinen API Key?',
        apiHelpLink: 'Hol dir einen bei Anthropic â†’',
        apiNoticeTitle: 'Wichtig:',
        apiNoticeText: 'Dein API-SchlÃ¼ssel wird in deinem Browser gespeichert. Alle deine Fortschritte, Antworten und GesprÃ¤che werden unter diesem SchlÃ¼ssel gespeichert. Vergiss deinen API-SchlÃ¼ssel nicht!',
        // Quick reply buttons
        sideIncome: 'ğŸ’° Nebeneinkommen',
        fullTime: 'ğŸš€ Vollzeit',
        exploring: 'ğŸ” Erkunden',
        oneHour: '1h/Tag',
        twoThreeHours: '2-3h/Tag',
        fourPlusHours: '4+h/Tag',
        beginner: 'ğŸŒ± AnfÃ¤nger',
        intermediate: 'ğŸ“š Mittel',
        advanced: 'ğŸš€ Fortgeschritten',
        // Completion popup
        congratulations: 'GlÃ¼ckwunsch!',
        moduleComplete: 'Modul Abgeschlossen',
        infoSaved: 'Deine Informationen wurden gespeichert und ich habe deinen personalisierten Lernpfad vorbereitet!',
        continueNext: 'Weiter zum nÃ¤chsten Modul â†’',
        repeatModule: 'ğŸ”„ Modul wiederholen',
        whatToCorrect: 'Welchen Bereich mÃ¶chtest du korrigieren?',
        yourName: 'Dein Name',
        yourGoal: 'Dein Ziel',
        timeAvailable: 'VerfÃ¼gbare Zeit',
        experience: 'Erfahrungslevel',
        progress: 'Fortschritt',
        // Intro steps
        stepName: 'Name',
        stepGoal: 'Ziel',
        stepTime: 'Zeit',
        stepExperience: 'Erfahrung',
        // Delete all
        deleteAllBtn: 'Alles lÃ¶schen',
        deleteWarningTitle: 'Vorsicht!',
        deleteWarningText: 'Alle deine Daten werden gelÃ¶scht und du startest von vorn. Bist du sicher?',
        deleteYes: 'Ja, alles lÃ¶schen',
        deleteNo: 'Abbrechen'
    },
    ru: {
        apiTitle: 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸ ÑĞ²Ğ¾Ğ¹ AI',
        apiSub: 'Ğ’Ğ²ĞµĞ´Ğ¸ ÑĞ²Ğ¾Ğ¹ Anthropic API ĞºĞ»ÑÑ‡ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ğ¿Ñ‹Ñ‚ RED AI Navigator. ĞšĞ»ÑÑ‡ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾.',
        apiBtn: 'ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ ĞŸÑƒÑ‚ÑŒ â†’',
        apiError: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ.',
        apiHelp: 'ĞĞµÑ‚ API ĞºĞ»ÑÑ‡Ğ°?',
        apiHelpLink: 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸ Ñƒ Anthropic â†’',
        apiNoticeTitle: 'Ğ’Ğ°Ğ¶Ğ½Ğ¾:',
        apiNoticeText: 'Ğ¢Ğ²Ğ¾Ğ¹ API-ĞºĞ»ÑÑ‡ Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ. Ğ’ÑĞµ Ñ‚Ğ²Ğ¾Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğ¸, Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ¸ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ¿Ğ¾Ğ´ ÑÑ‚Ğ¸Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼. ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒ ÑĞ²Ğ¾Ğ¹ API-ĞºĞ»ÑÑ‡!',
        // Quick reply buttons
        sideIncome: 'ğŸ’° Ğ”Ğ¾Ğ¿. Ğ´Ğ¾Ñ…Ğ¾Ğ´',
        fullTime: 'ğŸš€ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾ÑÑ‚ÑŒ',
        exploring: 'ğŸ” Ğ˜Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ğµ',
        oneHour: '1Ñ‡/Ğ´ĞµĞ½ÑŒ',
        twoThreeHours: '2-3Ñ‡/Ğ´ĞµĞ½ÑŒ',
        fourPlusHours: '4+Ñ‡/Ğ´ĞµĞ½ÑŒ',
        beginner: 'ğŸŒ± ĞĞ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº',
        intermediate: 'ğŸ“š Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹',
        advanced: 'ğŸš€ ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹',
        // Completion popup
        congratulations: 'ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼!',
        moduleComplete: 'ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½',
        infoSaved: 'Ğ¢Ğ²Ğ¾Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ° Ğ¸ Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ» Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ!',
        continueNext: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ â†’',
        repeatModule: 'ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ',
        whatToCorrect: 'Ğ§Ñ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ?',
        yourName: 'Ğ¢Ğ²Ğ¾Ñ‘ Ğ¸Ğ¼Ñ',
        yourGoal: 'Ğ¢Ğ²Ğ¾Ñ Ñ†ĞµĞ»ÑŒ',
        timeAvailable: 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ',
        experience: 'Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¾Ğ¿Ñ‹Ñ‚Ğ°',
        progress: 'ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ',
        // Intro steps
        stepName: 'Ğ˜Ğ¼Ñ',
        stepGoal: 'Ğ¦ĞµĞ»ÑŒ',
        stepTime: 'Ğ’Ñ€ĞµĞ¼Ñ',
        stepExperience: 'ĞĞ¿Ñ‹Ñ‚',
        // Delete all
        deleteAllBtn: 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘',
        deleteWarningTitle: 'Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ!',
        deleteWarningText: 'Ğ’ÑĞµ Ñ‚Ğ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ¸ Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ½Ñ‘ÑˆÑŒ Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°. Ğ¢Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½?',
        deleteYes: 'Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘',
        deleteNo: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°'
    }
};

function t(key) {
    return i18n[S.lang]?.[key] || i18n.en[key] || key;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER DATA PERSISTENCE (per API key)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getUserDataKey() {
    // Create a hash of API key for storage
    return 'red_ai_user_' + btoa(S.apiKey).substring(0, 20);
}

function saveUserData() {
    if (!S.apiKey) return;

    const userData = {
        lang: S.lang,
        completedModules: S.completedModules,
        profile: S.profile,
        introStep: S.introStep,
        answeredQuestions: S.answeredQuestions,
        moduleConversations: S.moduleConversations,
        lastUpdated: new Date().toISOString()
    };

    localStorage.setItem(getUserDataKey(), JSON.stringify(userData));
}

function loadUserData() {
    if (!S.apiKey) return;

    const data = localStorage.getItem(getUserDataKey());
    if (data) {
        try {
            const userData = JSON.parse(data);
            S.lang = userData.lang || S.lang;
            S.completedModules = userData.completedModules || [];
            S.profile = userData.profile || {};
            S.introStep = userData.introStep || 0;
            S.answeredQuestions = userData.answeredQuestions || {};
            S.moduleConversations = userData.moduleConversations || {};
            console.log('User data loaded successfully');
        } catch (e) {
            console.error('Failed to load user data:', e);
        }
    }
}

function saveConversation(moduleId) {
    if (!S.moduleConversations[moduleId]) {
        S.moduleConversations[moduleId] = [];
    }
    saveUserData();
}

function getConversation(moduleId) {
    return S.moduleConversations[moduleId] || [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE & API KEY SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectLang(lang) {
    S.lang = lang;
    document.getElementById('langOv').classList.add('hid');

    // Update API screen text
    document.getElementById('apiTitle').textContent = t('apiTitle');
    document.getElementById('apiSub').textContent = t('apiSub');
    document.getElementById('apiBtn').textContent = t('apiBtn');
    document.getElementById('apiNoticeTitle').textContent = t('apiNoticeTitle');
    document.getElementById('apiNoticeText').textContent = t('apiNoticeText');

    // Update intro step labels
    document.getElementById('step1Label').textContent = t('stepName');
    document.getElementById('step2Label').textContent = t('stepGoal');
    document.getElementById('step3Label').textContent = t('stepTime');
    document.getElementById('step4Label').textContent = t('stepExperience');

    // Show API screen or skip if already have key
    if (S.apiKey) {
        loadUserData();
        startApp();
    } else {
        document.getElementById('apiOv').classList.remove('hid');
    }
}

function saveApiKey() {
    const key = document.getElementById('apiKey').value.trim();
    if (!key || !key.startsWith('sk-ant-')) {
        document.getElementById('apiError').textContent = t('apiError');
        return;
    }

    S.apiKey = key;
    localStorage.setItem('red_ai_api_key', key);
    document.getElementById('apiError').textContent = '';

    loadUserData();
    startApp();
}

function resetApiKey() {
    localStorage.removeItem('red_ai_api_key');
    location.reload();
}

function startApp() {
    document.getElementById('apiOv').classList.add('hid');
    document.getElementById('app').style.display = 'grid';
    renderModuleList();
    initModule('intro');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTRO PROGRESS TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateIntroProgress(step) {
    S.introStep = step;
    saveUserData();

    // Update visual progress
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i <= step) {
            stepEl.classList.add('completed');
        } else {
            stepEl.classList.remove('completed');
        }
    }

    // Check if intro complete - mark as ready but don't auto-complete
    if (step >= 4) {
        S.introComplete = true;
        saveUserData();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModuleList() {
    const list = document.getElementById('moduleList');
    const moduleArray = Object.values(MODULES);
    const groups = {};

    moduleArray.forEach((m, i) => {
        if (!groups[m.group]) groups[m.group] = [];
        groups[m.group].push({ ...m, index: i });
    });

    list.innerHTML = Object.entries(groups).map(([group, modules]) => `
        <div class="module-group">
            <div class="module-group-title">${GROUPS[group][S.lang] || group}</div>
            ${modules.map(m => {
                const isLocked = m.index > 0 && !S.completedModules.includes(moduleArray[m.index - 1].id);
                const isCompleted = S.completedModules.includes(m.id);
                const isActive = S.currentModule === m.id;
                return `
                    <div class="module-item ${isLocked ? 'locked' : ''} ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}"
                         onclick="${isLocked ? '' : `selectModule('${m.id}')`}">
                        <div class="module-status">${isCompleted ? 'âœ“' : isLocked ? 'ğŸ”’' : m.icon}</div>
                        <div class="module-info">
                            <div class="module-name">${m.name[S.lang] || m.name.en}</div>
                            <div class="module-meta">${isCompleted ? 'Completed' : isLocked ? 'Locked' : 'Active'}</div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `).join('');

    updateProgress();
}

function updateProgress() {
    const total = Object.keys(MODULES).length;
    const completed = S.completedModules.length;
    const pct = Math.round((completed / total) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('totalProgress').textContent = pct + '%';
    document.getElementById('currentModule').textContent = MODULES[S.currentModule]?.name[S.lang] || 'Navigator';
}

function selectModule(moduleId) {
    S.currentModule = moduleId;

    // Show/hide intro progress
    if (moduleId === 'intro') {
        document.getElementById('introProgress').classList.add('show');
        updateIntroProgress(S.introStep);
    } else {
        document.getElementById('introProgress').classList.remove('show');
    }

    // Clear chat and reload conversation
    document.getElementById('chat').innerHTML = '';

    // Load saved conversation or start new
    const savedConv = getConversation(moduleId);
    if (savedConv.length > 0) {
        // Restore saved conversation
        savedConv.forEach(msg => {
            if (msg.role === 'assistant') {
                addBot(msg.content, true); // true = skip button logic
            } else {
                addUser(msg.content);
            }
        });
    } else {
        // Start new module
        initModule(moduleId);
    }

    renderModuleList();
}

function completeModule(moduleId) {
    if (!S.completedModules.includes(moduleId)) {
        S.completedModules.push(moduleId);
        saveUserData();
    }

    renderModuleList();
    showCompletionPopup(moduleId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI CONVERSATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYSTEM_PROMPTS = {
    intro: `You are the RED AI Navigator's onboarding assistant. Your goal is to understand the user and their goals for making money with AI.

Ask ONE question at a time in this order:
1. Their name (ask: "What is your name?")
2. Their main goal (ask: "What is your main goal - side income, full-time income, or just exploring?")
3. How much time they can invest daily (ask: "How much time can you invest daily?")
4. Their current experience level with AI (ask: "What is your experience level with AI?")

After each answer, give a brief encouraging response and ask the next question.
After all 4 questions are answered, give them a motivating summary about their learning path.

CRITICAL: After the summary, you MUST ask EXACTLY this question (translate to user's language):
German: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
English: "Would you like to repeat something or complete the module?"
Russian: "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ?"

This exact phrasing triggers buttons - DO NOT rephrase it!
DO NOT auto-complete - wait for user confirmation!

Keep it conversational and encouraging. Always respond in {LANG} language.`,

    what_is_ai: `You are teaching about AI basics in a highly interactive, step-by-step format.

IMPORTANT TEACHING FORMAT:
1. Present ONE small topic/concept at a time (max 3-4 sentences)
2. Give 1-2 concrete examples
3. Then STOP and ask: "Verstanden? Klick auf 'Verstanden âœ“' um weiterzumachen"
4. Wait for user to respond before continuing to next micro-topic

TOPICS TO COVER (one at a time):
1. What is AI? (Definition + 1 example)
2. Large Language Models / LLMs (What they do + example like ChatGPT)
3. Image AI (What it does + example like Midjourney)
4. Voice AI (What it does + example like ElevenLabs)
5. Video AI (What it does + example like Runway)
6. Tokens (Brief intro - will be covered in detail in next module)

After ALL topics are covered, give a quiz with 3 questions.

QUIZ FORMAT (CRITICAL - follow exactly):
1. Present quiz question 1 (multiple choice with 3-4 options, e.g., "A) ..., B) ..., C) ...")
2. WAIT for user's answer
3. VALIDATE the answer:
   - If user gives option letter (A/B/C) or correct content: Give feedback and continue
   - If answer is wrong/unclear: Say "âŒ Das ist nicht richtig. Versuch nochmal!" and repeat question 1
   - If user writes random text: Say "Bitte wÃ¤hle eine Option (A, B oder C)" and repeat question 1
4. ONLY when Q1 correctly answered: Present quiz question 2
5. WAIT for answer and VALIDATE
6. ONLY when Q2 correctly answered: Present quiz question 3
7. WAIT for answer and VALIDATE
8. ONLY AFTER all 3 questions correctly answered: give congratulations + brief summary

User MUST answer each question correctly to proceed to next question!

CRITICAL: After ALL quiz questions are answered and summary given, you MUST ask EXACTLY:
German: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
English: "Would you like to repeat something or complete the module?"
Russian: "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ?"

DO NOT show this question until ALL 3 quiz questions are answered!
This exact phrasing triggers buttons - DO NOT rephrase it!

Keep each explanation SHORT (3-4 sentences max), PRACTICAL, and income-focused.
Always respond in {LANG} language.`,

    tokens: `You are teaching about tokens in AI using a highly interactive, step-by-step format.

IMPORTANT TEACHING FORMAT:
1. Present ONE small concept at a time (max 3-4 sentences)
2. Give 1-2 concrete examples
3. Then STOP and ask: "Verstanden?"
4. Wait for user to respond before continuing to next micro-topic

TOPICS TO COVER (one at a time):
1. What are tokens? (Basic definition + simple example)
2. How do AI models use tokens? (Processing explanation)
3. Token counting (Show example: "Hello world" = ~2 tokens)
4. Why tokens matter for costs (Pricing structure + practical example)
5. How to optimize token usage (Tips for saving money)

After ALL topics covered, give a quiz with 3 questions.

QUIZ FORMAT (CRITICAL):
1. Ask question 1 (multiple choice: A/B/C) â†’ WAIT for answer
2. VALIDATE: If wrong/unclear, say "âŒ Nicht richtig. Versuch nochmal!" and repeat Q1
3. Only if correct: Give feedback (âœ… + explanation) and ask question 2
4. VALIDATE Q2, only proceed if correct
5. Ask question 3, VALIDATE, only proceed if correct
6. ONLY AFTER all 3 CORRECTLY answered: congratulations + summary

User MUST answer correctly to proceed! Don't skip validation.

CRITICAL: After ALL quiz questions answered, ask EXACTLY:
DE: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
EN: "Would you like to repeat something or complete the module?"
RU: "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ?"
DO NOT ask this until quiz is complete!

Keep explanations SHORT, PRACTICAL, and cost-focused.
Always respond in {LANG} language.`,

    context: `You are teaching about context in AI using a highly interactive, step-by-step format.

TEACHING FORMAT:
1. Present ONE concept at a time (3-4 sentences max)
2. Give practical example
3. Ask: "Verstanden?"
4. Wait for response

TOPICS (one at a time):
1. What is context in AI?
2. Why context matters for output quality
3. How to structure good prompts
4. Context window limits
5. Best practices with examples

After topics: Quiz (3 questions).

QUIZ FORMAT:
Q1 (A/B/C options) â†’ Wait â†’ VALIDATE (if wrong: repeat Q1, if right: feedback + Q2)
Q2 â†’ Wait â†’ VALIDATE (if wrong: repeat Q2, if right: feedback + Q3)
Q3 â†’ Wait â†’ VALIDATE (if wrong: repeat Q3, if right: feedback + Summary)
User MUST answer correctly to proceed!

CRITICAL: After ALL 3 quiz questions CORRECTLY answered, ask EXACTLY:
DE: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
EN: "Would you like to repeat something or complete the module?"
RU: "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ?"
Always respond in {LANG} language.`,

    voiceovers: `You are teaching AI Voiceovers income method interactively.

FORMAT: Present ONE topic â†’ Example â†’ "Verstanden?" â†’ Wait

TOPICS (one at a time):
1. What are AI Voiceovers? + use cases
2. Best tools (ElevenLabs, Play.ht, Murf)
3. How to get started (step-by-step)
4. Income potential (â‚¬500-2000/month + examples)
5. Finding first clients

After topics: Quiz (3 questions).
QUIZ FORMAT: Q1 (A/B/C) â†’ Wait â†’ VALIDATE (wrong=repeat Q1, right=feedback+Q2) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary
User must answer correctly to proceed!
Then ask: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
Always respond in {LANG} language.`,

    imagegen: `Interactive teaching: AI Image Generation
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) What is AI Image Gen 2) Tools (Midjourney, DALL-E, Stable Diffusion, Leonardo) 3) Prompting tips 4) Income potential 5) Getting clients
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    videogen: `Interactive teaching: AI Video Generation
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) What is AI Video 2) Tools (Runway, Pika, HeyGen) 3) Faceless YouTube strategy 4) Shorts creation 5) Income (â‚¬1000-5000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    chatbots: `Interactive teaching: AI Chatbots
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) What are chatbots 2) Business use cases 3) Customer service automation 4) Lead generation 5) Tools & income (â‚¬2000-10000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    automation: `Interactive teaching: AI Automation
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) What is AI Automation 2) Tools (Make.com, Zapier, n8n) 3) Workflows examples 4) Business applications 5) Income (â‚¬1500-5000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    copywriting: `Interactive teaching: AI Copywriting
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) AI Copywriting basics 2) Frameworks (AIDA, PAS, BAB) 3) Best tools 4) Getting first clients 5) Income (â‚¬1000-5000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    websites: `Interactive teaching: AI Website Building
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) AI website tools overview 2) Framer AI 3) v0.dev & Cursor 4) No-code options 5) Income (â‚¬1000-4000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    research: `Interactive teaching: AI Research Services
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) AI Research capabilities 2) Market research 3) Competitor analysis 4) Data processing 5) Income (â‚¬1000-4000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    consulting: `Interactive teaching: AI Consulting
FORMAT: 1 topic â†’ Example â†’ "Verstanden?" â†’ Wait
TOPICS: 1) What is AI Consulting 2) Strategy & implementation 3) Training services 4) Pricing (â‚¬100-300/h, â‚¬1000-10000/project) 5) Income (â‚¬3000-20000/mo)
After: Quiz (3 Q). QUIZ: Q1 (A/B/C) â†’ VALIDATE (wrong=repeat, right=next) â†’ Q2 â†’ VALIDATE â†’ Q3 â†’ VALIDATE â†’ Summary. Then: "MÃ¶chtest du etwas wiederholen oder das Modul abschlieÃŸen?"
{LANG} language.`,

    choose_path: `You are helping the user choose their AI income path. They've learned all 9 methods. Help them pick 1-3 that fit their profile.
Also present the option for premium 1:1 guidance with branding/marketing (â‚¬3k+ investment).
Always respond in {LANG} language.`,

    project: `You are the user's personal AI project coach. Help them set specific goals, analyze screenshots they upload, give actionable advice.
Be supportive, strategic, and focused on their chosen income methods. Reference their profile data.
Always respond in {LANG} language.`
};

function getSystemPrompt(moduleId) {
    const langNames = { en: 'English', de: 'German', ru: 'Russian' };
    let prompt = SYSTEM_PROMPTS[moduleId] || SYSTEM_PROMPTS.intro;
    prompt = prompt.replace('{LANG}', langNames[S.lang] || 'English');

    // Add profile context if available
    if (Object.keys(S.profile).length > 0) {
        prompt += `\n\nUser Profile: ${JSON.stringify(S.profile)}`;
    }

    return prompt;
}

async function callAnthropic(messages, system) {
    const response = await fetch('https://api-proxy-rho-five.vercel.app/api/claude', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': S.apiKey,
            'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 2048,
            system: system,
            messages: messages
        })
    });

    if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
    }

    return await response.json();
}

async function initModule(moduleId) {
    // Load existing conversation or start new
    const conversation = getConversation(moduleId);

    if (conversation.length === 0) {
        // Start new module
        addTyping();

        try {
            const response = await callAnthropic([{
                role: 'user',
                content: `Start the ${moduleId} module. Greet me and begin the lesson.`
            }], getSystemPrompt(moduleId));

            removeTyping();
            const text = response.content[0].text;

            // Save to conversation history
            if (!S.moduleConversations[moduleId]) {
                S.moduleConversations[moduleId] = [];
            }
            S.moduleConversations[moduleId].push({ role: 'assistant', content: text });
            saveConversation(moduleId);

            addBot(text);

        } catch (e) {
            removeTyping();
            console.error('AI Error:', e);
            const errorMsg = `âš ï¸ Connection error: ${e.message || 'Unknown error'}. <button onclick="resetApiKey()" style="margin-left:10px;padding:8px 16px;background:#dc2626;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Reset API Key</button>`;
            addBot(errorMsg, true);
        }
    }
}

async function send() {
    const txt = document.getElementById('inp').value.trim();
    if (!txt) return;

    addUser(txt);
    document.getElementById('inp').value = '';
    document.getElementById('inp').style.height = 'auto';

    // Save to conversation history
    if (!S.moduleConversations[S.currentModule]) {
        S.moduleConversations[S.currentModule] = [];
    }
    S.moduleConversations[S.currentModule].push({ role: 'user', content: txt });

    // Show typing
    addTyping();
    document.getElementById('sendBtn').disabled = true;

    try {
        const conversation = getConversation(S.currentModule);
        const response = await callAnthropic(conversation, getSystemPrompt(S.currentModule));

        removeTyping();
        document.getElementById('sendBtn').disabled = false;

        const text = response.content[0].text;
        S.moduleConversations[S.currentModule].push({ role: 'assistant', content: text });
        saveConversation(S.currentModule);

        addBot(text);

        // Intro module progress tracking
        if (S.currentModule === 'intro') {
            // For text input (non-button answers), we need to mark them as answered
            // Buttons already set answeredQuestions in quickReply()
            const lowerText = txt.toLowerCase();

            if (S.introStep === 0 && !S.answeredQuestions['name'] && txt.length > 0) {
                S.answeredQuestions['name'] = txt;
            } else if (S.introStep === 1 && !S.answeredQuestions['goal']) {
                S.answeredQuestions['goal'] = txt;
            } else if (S.introStep === 2 && !S.answeredQuestions['time']) {
                S.answeredQuestions['time'] = txt;
            } else if (S.introStep === 3 && !S.answeredQuestions['experience']) {
                S.answeredQuestions['experience'] = txt;
            }

            // Now check if we just answered a question and update progress
            if (S.introStep === 0 && S.answeredQuestions['name']) {
                S.profile.name = S.answeredQuestions['name'];
                updateIntroProgress(1);
            } else if (S.introStep === 1 && S.answeredQuestions['goal']) {
                S.profile.goal = S.answeredQuestions['goal'];
                updateIntroProgress(2);
            } else if (S.introStep === 2 && S.answeredQuestions['time']) {
                S.profile.time = S.answeredQuestions['time'];
                updateIntroProgress(3);
            } else if (S.introStep === 3 && S.answeredQuestions['experience']) {
                S.profile.experience = S.answeredQuestions['experience'];
                updateIntroProgress(4);
            }

            saveUserData();
        }

    } catch (e) {
        removeTyping();
        document.getElementById('sendBtn').disabled = false;
        console.error('AI Error:', e);
        const errorMsg = `âš ï¸ Error: ${e.message || 'Unknown error'}. <button onclick="resetApiKey()" style="margin-left:10px;padding:8px 16px;background:#dc2626;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Reset API Key</button>`;
        addBot(errorMsg, true);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addBot(msg, skipButtons = false) {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg bot';

    let html = `<div class="msg-bub">${msg.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;

    // Add quick reply buttons
    if (!skipButtons && msg.includes('?')) {
        const msgLower = msg.toLowerCase();

        // Module completion buttons - ALWAYS show when AI asks if user wants to repeat or finish
        // This takes priority over other buttons
        const hasRepeatKeyword = msgLower.includes('wiederholen') || msgLower.includes('repeat') || msgLower.includes('Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ') || msgLower.includes('fragen');
        const hasFinishKeyword = msgLower.includes('abschlieÃŸen') || msgLower.includes('finish') || msgLower.includes('complete') || msgLower.includes('Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ') || msgLower.includes('modul');

        if (hasRepeatKeyword && hasFinishKeyword) {
            html += `<div class="quick-replies completion-buttons">
                <button class="quick-btn" onclick="handleModuleRepeat()" style="background: #f59e0b; border-color: #f59e0b;">ğŸ”„ ${t('repeatModule')}</button>
                <button class="quick-btn" onclick="handleModuleComplete()" style="background: #10b981; border-color: #10b981;">âœ… Modul abschlieÃŸen</button>
            </div>`;
        }
        // "Verstanden" button for interactive lessons
        else if (msgLower.includes('verstanden') || msgLower.includes('understood') || msgLower.includes('Ğ¿Ğ¾Ğ½ÑĞ»')) {
            html += `<div class="quick-replies">
                <button class="quick-btn" onclick="quickReply('Verstanden âœ“', 'understood')" style="background: #10b981; border-color: #10b981;">âœ… Verstanden</button>
            </div>`;
        }
        // Intro module specific buttons - only show if NOT completion question
        else if (S.currentModule === 'intro') {
            // Name question - NO buttons (user should type)
            if ((msgLower.includes('name') || msgLower.includes('heiÃŸt') || msgLower.includes('Ğ¸Ğ¼Ñ')) && !S.answeredQuestions['name']) {
                // No buttons for name
            }
            // Goal question
            else if ((msgLower.includes('goal') || msgLower.includes('ziel') || msgLower.includes('Ñ†ĞµĞ»') || msgLower.includes('hauptziel')) && !S.answeredQuestions['goal']) {
                html += `<div class="quick-replies">
                    <button class="quick-btn" onclick="quickReply('${t('sideIncome')}', 'goal')">${t('sideIncome')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('fullTime')}', 'goal')">${t('fullTime')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('exploring')}', 'goal')">${t('exploring')}</button>
                </div>`;
            }
            // Time question
            else if ((msgLower.includes('time') || msgLower.includes('zeit') || msgLower.includes('Ğ²Ñ€ĞµĞ¼') || msgLower.includes('tÃ¤glich') || msgLower.includes('invest')) && !S.answeredQuestions['time']) {
                html += `<div class="quick-replies">
                    <button class="quick-btn" onclick="quickReply('${t('oneHour')}', 'time')">${t('oneHour')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('twoThreeHours')}', 'time')">${t('twoThreeHours')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('fourPlusHours')}', 'time')">${t('fourPlusHours')}</button>
                </div>`;
            }
            // Experience question
            else if ((msgLower.includes('experience') || msgLower.includes('erfahrung') || msgLower.includes('Ğ¾Ğ¿Ñ‹Ñ‚') || msgLower.includes('level') || msgLower.includes('kenntnisse')) && !S.answeredQuestions['experience']) {
                html += `<div class="quick-replies">
                    <button class="quick-btn" onclick="quickReply('${t('beginner')}', 'experience')">${t('beginner')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('intermediate')}', 'experience')">${t('intermediate')}</button>
                    <button class="quick-btn" onclick="quickReply('${t('advanced')}', 'experience')">${t('advanced')}</button>
                </div>`;
            }
        }
    }

    div.innerHTML = html;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function quickReply(text, questionType) {
    // Mark question as answered
    S.answeredQuestions[questionType] = text;

    // Remove ALL buttons from page
    document.querySelectorAll('.quick-replies').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => el.remove(), 300);
    });

    // Send the response
    document.getElementById('inp').value = text;
    setTimeout(() => send(), 350);
}

function addUser(txt, img = null) {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg user';
    div.innerHTML = `<div class="msg-bub">${txt}${img ? `<img src="${img}">` : ''}</div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function addTyping() {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg bot typing-msg';
    div.innerHTML = '<div class="msg-bub"><div class="typing"><span></span><span></span><span></span></div></div>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function removeTyping() {
    const typing = document.querySelector('.typing-msg');
    if (typing) typing.remove();
}

function toggleTheme() {
    const th = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = th;
    document.getElementById('themeBtn').textContent = th === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}

// Input handling
const inp = document.getElementById('inp');
inp.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
    }
}

// File upload
const fi = document.getElementById('fi');
function toggleDrop() { fi.click(); }
fi.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f?.type.startsWith('image/')) return;

    const r = new FileReader();
    r.onload = async (ev) => {
        const base64 = ev.target.result.split(',')[1];

        addUser('ğŸ“· Image uploaded', ev.target.result);
        addTyping();

        try {
            const imageMessage = {
                role: 'user',
                content: [
                    { type: 'image', source: { type: 'base64', media_type: f.type, data: base64 } },
                    { type: 'text', text: 'I uploaded this image. Please analyze it and give me feedback.' }
                ]
            };

            const conversation = getConversation(S.currentModule);
            const response = await callAnthropic([...conversation, imageMessage], getSystemPrompt(S.currentModule));

            removeTyping();
            const text = response.content[0].text;

            S.moduleConversations[S.currentModule].push(imageMessage);
            S.moduleConversations[S.currentModule].push({ role: 'assistant', content: text });
            saveConversation(S.currentModule);

            addBot(text, true);

        } catch (e) {
            removeTyping();
            console.error('Image analysis error:', e);
            addBot("I received your image! I'll analyze it to help with your project.", true);
        }
    };
    r.readAsDataURL(f);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const confettiCanvas = document.getElementById('confetti');
const confettiCtx = confettiCanvas.getContext('2d');
let confettiParticles = [];

function initConfetti() {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiParticles = [];

    const colors = ['#dc2626', '#ef4444', '#f87171', '#fca5a5', '#fee2e2', '#ffd700', '#ffed4e'];

    for (let i = 0; i < 150; i++) {
        confettiParticles.push({
            x: Math.random() * confettiCanvas.width,
            y: Math.random() * confettiCanvas.height - confettiCanvas.height,
            vx: (Math.random() - 0.5) * 3,
            vy: Math.random() * 3 + 2,
            rotation: Math.random() * 360,
            rotationSpeed: (Math.random() - 0.5) * 10,
            size: Math.random() * 8 + 4,
            color: colors[Math.floor(Math.random() * colors.length)],
            shape: Math.random() > 0.5 ? 'rect' : 'circle'
        });
    }
}

function animateConfetti() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

    confettiParticles.forEach((p, index) => {
        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate((p.rotation * Math.PI) / 180);

        confettiCtx.fillStyle = p.color;

        if (p.shape === 'rect') {
            confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
        } else {
            confettiCtx.beginPath();
            confettiCtx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
            confettiCtx.fill();
        }

        confettiCtx.restore();

        p.x += p.vx;
        p.y += p.vy;
        p.rotation += p.rotationSpeed;
        p.vy += 0.1; // Gravity

        if (p.y > confettiCanvas.height + 50) {
            confettiParticles.splice(index, 1);
        }
    });

    if (confettiParticles.length > 0) {
        requestAnimationFrame(animateConfetti);
    } else {
        confettiCanvas.classList.remove('show');
    }
}

function launchConfetti() {
    confettiCanvas.classList.add('show');
    initConfetti();
    animateConfetti();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPLETION POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCompletionPopup(moduleId) {
    document.getElementById('completionTitle').textContent = t('congratulations');
    document.getElementById('completionSubtitle').textContent = t('moduleComplete');
    document.getElementById('completionMessage').textContent = t('infoSaved');
    document.getElementById('continueBtn').textContent = t('continueNext');
    document.getElementById('repeatBtn').textContent = t('repeatModule');
    document.getElementById('correctionTitle').textContent = t('whatToCorrect');
    document.getElementById('corrField1').textContent = t('yourName');
    document.getElementById('corrField2').textContent = t('yourGoal');
    document.getElementById('corrField3').textContent = t('timeAvailable');
    document.getElementById('corrField4').textContent = t('experience');

    const total = Object.keys(MODULES).length;
    const completed = S.completedModules.length;
    const percentage = Math.round((completed / total) * 100);

    document.getElementById('progressCompleteLabel').textContent = `${t('progress')}: ${percentage}%`;

    document.getElementById('completionOv').classList.add('show');

    setTimeout(launchConfetti, 300);

    setTimeout(() => {
        document.getElementById('progressCompleteFill').style.width = percentage + '%';
    }, 800);

    S.nextModuleId = getNextModuleId(moduleId);
}

function getNextModuleId(currentId) {
    const moduleIds = Object.keys(MODULES);
    const currentIndex = moduleIds.indexOf(currentId);
    if (currentIndex < moduleIds.length - 1) {
        return moduleIds[currentIndex + 1];
    }
    return null;
}

function continueToNextModule() {
    document.getElementById('completionOv').classList.remove('show');
    document.getElementById('correctionOptions').classList.remove('show');
    document.getElementById('completionActions').style.display = 'flex';

    if (S.nextModuleId) {
        setTimeout(() => {
            selectModule(S.nextModuleId);
        }, 500);
    }
}

function showCorrectionOptions() {
    document.getElementById('completionActions').style.display = 'none';
    document.getElementById('correctionOptions').classList.add('show');
}

function correctField(field) {
    document.getElementById('completionOv').classList.remove('show');
    document.getElementById('correctionOptions').classList.remove('show');
    document.getElementById('completionActions').style.display = 'flex';

    // Reset the specific question
    delete S.answeredQuestions[field];

    // Reset intro step based on field
    const stepMap = { name: 0, goal: 1, time: 2, experience: 3 };
    S.introStep = stepMap[field] || 0;
    updateIntroProgress(S.introStep);

    // Clear conversation and restart
    S.moduleConversations['intro'] = [];
    selectModule('intro');
}

window.addEventListener('resize', () => {
    if (confettiCanvas.classList.contains('show')) {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE COMPLETION HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleModuleComplete() {
    // Remove buttons
    document.querySelectorAll('.quick-replies').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => el.remove(), 300);
    });

    // Show completion popup with confetti
    setTimeout(() => {
        completeModule(S.currentModule);
    }, 500);
}

function handleModuleRepeat() {
    // Remove buttons
    document.querySelectorAll('.quick-replies').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => el.remove(), 300);
    });

    // Show inline correction options for intro
    if (S.currentModule === 'intro') {
        setTimeout(() => {
            showInlineCorrectionOptions();
        }, 500);
    } else {
        // For other modules, clear conversation and restart
        setTimeout(() => {
            S.moduleConversations[S.currentModule] = [];
            document.getElementById('chat').innerHTML = '';
            initModule(S.currentModule);
        }, 500);
    }
}

function showInlineCorrectionOptions() {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg bot';
    div.innerHTML = `
        <div class="msg-bub">
            <strong>${t('whatToCorrect')}</strong>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;">
                <button onclick="correctField('name')" class="quick-btn" style="background:#f59e0b;border-color:#f59e0b;">ğŸ“ ${t('yourName')}</button>
                <button onclick="correctField('goal')" class="quick-btn" style="background:#f59e0b;border-color:#f59e0b;">ğŸ¯ ${t('yourGoal')}</button>
                <button onclick="correctField('time')" class="quick-btn" style="background:#f59e0b;border-color:#f59e0b;">â° ${t('timeAvailable')}</button>
                <button onclick="correctField('experience')" class="quick-btn" style="background:#f59e0b;border-color:#f59e0b;">ğŸ“Š ${t('experience')}</button>
            </div>
        </div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE ALL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmDeleteAll() {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background:#1a1a1a;border:2px solid #dc2626;border-radius:16px;padding:32px;max-width:400px;text-align:center;animation:scaleIn 0.3s;';

    modal.innerHTML = `
        <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
        <h2 style="color:#dc2626;margin:0 0 16px 0;font-size:24px;">${t('deleteWarningTitle')}</h2>
        <p style="color:#fff;margin:0 0 24px 0;line-height:1.6;">${t('deleteWarningText')}</p>
        <div style="display:flex;gap:12px;justify-content:center;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ${t('deleteNo')}
            </button>
            <button onclick="deleteAllData()" style="padding:12px 24px;background:#dc2626;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ${t('deleteYes')}
            </button>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function deleteAllData() {
    // Remove user data from localStorage
    if (S.apiKey) {
        localStorage.removeItem(getUserDataKey());
    }

    // Reset global state
    S.completedModules = [];
    S.profile = {};
    S.introStep = 0;
    S.answeredQuestions = {};
    S.moduleConversations = {};
    S.currentModule = 'intro';

    // Close modal
    document.querySelectorAll('[style*="fixed"]').forEach(el => el.remove());

    // Reload to intro
    document.getElementById('chat').innerHTML = '';
    renderModuleList();
    selectModule('intro');

    // Show success message
    setTimeout(() => {
        addBot('âœ… Alle Daten wurden gelÃ¶scht. Willkommen zurÃ¼ck!', true);
    }, 500);
}
</script>
</body>
</html>
